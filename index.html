<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USD Denominated Fund Terminal - User Version</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-green-400 font-mono p-4 min-h-screen">
    <h1 class="text-3xl font-bold mb-4 text-green-500">USD Denominated Fund Terminal</h1>
    
    <div id="server-warning" class="border border-yellow-500 text-yellow-500 px-4 py-3 rounded relative mb-4" role="alert" style="display: none;">
        <strong class="font-bold">Note:</strong>
        <span class="block sm:inline"> This app requires a web server to function with MetaMask. If you're seeing this message, please ensure you're accessing this file through a web server, not directly from your file system.</span>
    </div>
    
    <div id="error" class="border border-red-500 text-red-500 px-4 py-3 rounded relative mb-4" role="alert" style="display: none;">
        <strong class="font-bold">Error:</strong>
        <span id="error-message" class="block sm:inline"></span>
    </div>
    
    <div id="account-info" class="border border-green-500 rounded px-4 py-3 mb-4" style="display: none;">
        <h2 class="text-xl font-bold mb-2 text-green-500">Account Information</h2>
        <p>Address: <span id="account" class="text-yellow-400"></span></p>
        <p>Balance: <span id="balance" class="text-yellow-400"></span> BNB</p>
        <p>Shares: <span id="shares" class="text-yellow-400"></span></p>
        <p>Total Fund Value: <span id="total-fund-value" class="text-yellow-400"></span> BUSD</p>
    </div>
    
    <div id="fund-composition" class="border border-green-500 rounded px-4 py-3 mb-4" style="display: none;">
        <h2 class="text-xl font-bold mb-2 text-green-500">Fund Composition</h2>
        <div id="composition-details">Loading fund composition...</div>
    </div>
    
    <div class="border border-green-500 rounded px-4 py-3 mb-4">
        <h2 class="text-xl font-bold mb-2 text-green-500">Deposit</h2>
        <input 
            type="number" 
            id="deposit-amount"
            placeholder="Amount in BNB"
            class="bg-black text-green-400 border border-green-500 rounded w-full py-2 px-3 mb-2 focus:outline-none focus:border-green-700"
        />
        <button 
            onclick="handleDeposit()"
            class="bg-green-700 hover:bg-green-600 text-black font-bold py-2 px-4 rounded focus:outline-none"
        >
            Deposit
        </button>
    </div>
    
    <div class="border border-green-500 rounded px-4 py-3 mb-4">
        <h2 class="text-xl font-bold mb-2 text-green-500">Withdraw</h2>
        <input 
            type="number" 
            id="withdraw-amount"
            placeholder="Amount of shares"
            class="bg-black text-green-400 border border-green-500 rounded w-full py-2 px-3 mb-2 focus:outline-none focus:border-green-700"
        />
        <button 
            onclick="handleWithdraw()"
            class="bg-green-700 hover:bg-green-600 text-black font-bold py-2 px-4 rounded focus:outline-none"
        >
            Withdraw
        </button>
    </div>

    <script>
        const FUND_CONTRACT_ADDRESS = '0x...';
        const BUSD_ADDRESS = '0x...';
        const PANCAKESWAP_ROUTER_ADDRESS = '0x...';

        let provider, signer, fundContract, account;

        const FUND_ABI = [];

        const PANCAKESWAP_ROUTER_ABI = [];

        function setError(message) {
            const errorElement = document.getElementById('error');
            const errorMessageElement = document.getElementById('error-message');
            if (errorElement && errorMessageElement) {
                errorElement.style.display = 'block';
                errorMessageElement.textContent = message;
            } else {
                console.error('Error element not found in DOM');
                console.error(message);
            }
        }

        function showElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'block';
            }
        }

        function hideElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'none';
            }
        }

        async function initializeApp() {
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                
                fundContract = new ethers.Contract(FUND_CONTRACT_ADDRESS, FUND_ABI, signer);
                
                account = await signer.getAddress();
                const accountElement = document.getElementById('account');
                if (accountElement) {
                    accountElement.textContent = account;
                }

                showElement('account-info');
                showElement('fund-composition');

                await updateBalances();
                await getFundComposition();
            } catch (err) {
                if (err.code === 4001) {
                    setError('Please connect MetaMask to use this dApp.');
                } else {
                    setError('Failed to initialize app: ' + err.message);
                }
            }
        }

        async function init() {
            if (window.location.protocol === 'file:') {
                showElement('server-warning');
                setError('Please access this file through a web server to use MetaMask.');
                return;
            } else {
                hideElement('server-warning');
            }

            if (typeof window.ethereum !== 'undefined') {
                console.log("MetaMask is installed!");

                if (window.ethereum.isMetaMask) {
                    console.log("MetaMask is active");
                    
                    await initializeApp();

                    // Listen for account changes
                    window.ethereum.on('accountsChanged', async (accounts) => {
                        console.log('Account changed:', accounts[0]);
                        await initializeApp();
                    });

                    // Listen for chain changes
                    window.ethereum.on('chainChanged', (chainId) => {
                        console.log('Network changed. Reloading...');
                        window.location.reload();
                    });

                } else {
                    setError('MetaMask is installed but not active. Please make sure it\'s enabled.');
                }
            } else {
                setError('Please install MetaMask to use this dApp');
            }
        }

        async function updateBalances() {
            if (!provider || !fundContract || !account) return;

            try {
                const balance = await provider.getBalance(account);
                const shares = await fundContract.shares(account);
                const totalFundValue = await fundContract.getTotalFundValue();
                
                document.getElementById('balance').textContent = ethers.utils.formatEther(balance);
                document.getElementById('shares').textContent = ethers.utils.formatUnits(shares, 18);
                document.getElementById('total-fund-value').textContent = ethers.utils.formatUnits(totalFundValue, 18);
            } catch (err) {
                setError('Failed to update balances: ' + err.message);
            }
        }

        async function getFundComposition() {
            if (!fundContract || !provider) {
                setError('Contract or provider not initialized');
                return;
            }
            
            try {
                const totalValue = await fundContract.getTotalFundValue();
                const stablecoinBalance = await fundContract.freeBUSDBalance();
                
                const pancakeSwapRouter = new ethers.Contract(PANCAKESWAP_ROUTER_ADDRESS, PANCAKESWAP_ROUTER_ABI, provider);
                
                let tokens = [];
                let balances = [];
                let busdValues = [];
                let i = 0;
                
                while (true) {
                    try {
                        const token = await fundContract.supportedTokens(i);
                        if (token === ethers.constants.AddressZero) {
                            break;
                        }
                        
                        const balance = await fundContract.tokenBalances(token);
                        const formattedBalance = ethers.utils.formatUnits(balance, 18);
                        
                        let busdValue;
                        if (token.toLowerCase() === BUSD_ADDRESS.toLowerCase()) {
                            busdValue = parseFloat(formattedBalance);
                        } else {
                            const amounts = await pancakeSwapRouter.getAmountsOut(
                                ethers.utils.parseUnits('1', 18),
                                [token, BUSD_ADDRESS]
                            );
                            const tokenPriceInBUSD = ethers.utils.formatUnits(amounts[1], 18);
                            busdValue = parseFloat(formattedBalance) * parseFloat(tokenPriceInBUSD);
                        }
                        
                        tokens.push(token);
                        balances.push(formattedBalance);
                        busdValues.push(busdValue.toFixed(2));
                        
                        i++;
                    } catch (error) {
                        console.log(`Error fetching token at index ${i}:`, error.message);
                        break;
                    }
                }
                
                const compositionHtml = `
                    <p>Total Fund Value: <span class="text-yellow-400">${ethers.utils.formatUnits(totalValue, 18)}</span> BUSD</p>
                    <p>Stablecoin Balance: <span class="text-yellow-400">${ethers.utils.formatUnits(stablecoinBalance, 18)}</span> BUSD</p>
                    <h3 class="font-bold mt-2 text-green-500">Token Balances:</h3>
                    ${tokens
                        .filter(token => token.toLowerCase() !== BUSD_ADDRESS.toLowerCase())
                        .map((token, index) => {
                            const originalIndex = tokens.indexOf(token);
                            return `
                                <p>
                                    <span class="text-blue-400">${token}:</span> 
                                    <span class="text-yellow-400">${balances[originalIndex]}</span> tokens 
                                    (≈ <span class="text-yellow-400">${busdValues[originalIndex]}</span> BUSD)
                                </p>
                            `;
                        }).join('')}
                `;
                
                document.getElementById('composition-details').innerHTML = compositionHtml;
            } catch (err) {
                setError('Failed to get fund composition: ' + err.message);
            }
        }

        async function handleDeposit() {
            if (!fundContract) return;
            try {
                const depositAmount = document.getElementById('deposit-amount').value;
                const tx = await fundContract.deposit({ value: ethers.utils.parseEther(depositAmount) });
                await tx.wait();
                updateBalances();
                getFundComposition();
                document.getElementById('deposit-amount').value = '';
            } catch (err) {
                setError('Deposit failed: ' + err.message);
            }
        }

        async function handleWithdraw() {
            if (!fundContract) return;
            try {
                const withdrawAmount = document.getElementById('withdraw-amount').value;
                const tx = await fundContract.withdraw(ethers.utils.parseUnits(withdrawAmount, 18));
                await tx.wait();
                updateBalances();
                getFundComposition();
                document.getElementById('withdraw-amount').value = '';
            } catch (err) {
                setError('Withdrawal failed: ' + err.message);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
