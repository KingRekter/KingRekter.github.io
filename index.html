<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USD Denominated Fund Terminal - User Version</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-black text-green-400 font-mono p-4 min-h-screen">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
        <h1 class="text-3xl font-bold text-green-500">USD Denominated Fund Terminal</h1>
        <div class="text-yellow-400 mt-2 sm:mt-0">
            <p id="contract-address">Contract: Loading...</p>
            <p id="network-type">Network: Loading...</p>
        </div>
    </div>

    <div id="server-warning" class="border border-yellow-500 text-yellow-500 px-4 py-3 rounded relative mb-4"
        role="alert" style="display: none;">
        <strong class="font-bold">Note:</strong>
        <span class="block sm:inline"> This app requires a web server to function with MetaMask. If you're seeing this
            message, please ensure you're accessing this file through a web server, not directly from your file
            system.</span>
    </div>

    <div id="error" class="border border-red-500 text-red-500 px-4 py-3 rounded relative mb-4" role="alert"
        style="display: none;">
        <strong class="font-bold">Error:</strong>
        <span id="error-message" class="block sm:inline"></span>
    </div>

    <div class="border border-green-500 rounded px-4 py-3 mb-4">
        <h2 class="text-xl font-bold mb-2 text-green-500">Network Management</h2>
        <div id="network-buttons">
            <!-- Buttons will be dynamically added here -->
        </div>
    </div>

    <div id="account-info" class="border border-green-500 rounded px-4 py-3 mb-4" style="display: none;">
        <h2 class="text-xl font-bold mb-2 text-green-500">Account Information</h2>
        <p>Address: <span id="account" class="text-yellow-400"></span></p>
        <p>Balance: <span id="balance" class="text-yellow-400"></span> BNB</p>
        <p>Shares: <span id="shares" class="text-yellow-400"></span></p>
        <p>Total Fund Value: <span id="total-fund-value" class="text-yellow-400"></span> BUSD</p>
    </div>

    <div id="fund-composition" class="border border-green-500 rounded px-4 py-3 mb-4" style="display: none;">
        <h2 class="text-xl font-bold mb-2 text-green-500">Fund Composition</h2>
        <div id="composition-details">Loading fund composition...</div>
    </div>

    <div class="border border-green-500 rounded px-4 py-3 mb-4">
        <h2 class="text-xl font-bold mb-2 text-green-500">Deposit</h2>
        <input type="number" id="deposit-amount" placeholder="Amount in BNB"
            class="bg-black text-green-400 border border-green-500 rounded w-full py-2 px-3 mb-2 focus:outline-none focus:border-green-700" />
        <button onclick="handleDeposit()"
            class="bg-green-700 hover:bg-green-600 text-black font-bold py-2 px-4 rounded focus:outline-none">
            Deposit
        </button>
    </div>

    <div class="border border-green-500 rounded px-4 py-3 mb-4">
        <h2 class="text-xl font-bold mb-2 text-green-500">Withdraw</h2>
        <input type="number" id="withdraw-amount" placeholder="Amount of shares"
            class="bg-black text-green-400 border border-green-500 rounded w-full py-2 px-3 mb-2 focus:outline-none focus:border-green-700" />
        <button onclick="handleWithdraw()"
            class="bg-green-700 hover:bg-green-600 text-black font-bold py-2 px-4 rounded focus:outline-none">
            Withdraw
        </button>
    </div>

    <script>
        const BSC_MAINNET_CHAIN_ID = '0x38';
        const BSC_TESTNET_CHAIN_ID = '0x61';

        const CONTRACT_ADDRESSES = {
            [BSC_MAINNET_CHAIN_ID]: {
                FUND_CONTRACT: '',
                BUSD: '',
                PANCAKESWAP_ROUTER: ''
            },
            [BSC_TESTNET_CHAIN_ID]: {
                FUND_CONTRACT: '0xF0beB182f6faD829F983D5F72d3DBDbA5A45623c',
                BUSD: '0x78867BbEeF44f2326bF8DDd1941a4439382EF2A7',
                PANCAKESWAP_ROUTER: '0xD99D1c33F9fC3444f8101754aBC46c52416550D1'
            }
        };

        let provider, signer, fundContract, account, currentChainId;

        const FUND_ABI = [
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_smartEngine",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "_stablecoin",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "_dexRouter",
                        "type": "address"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "bnbAmount",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "sharesMinted",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "fee",
                        "type": "uint256"
                    }
                ],
                "name": "Deposit",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "FeesWithdrawn",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "tokenIn",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "tokenInAmount",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "stablecoinReceived",
                        "type": "uint256"
                    }
                ],
                "name": "StablecoinReturn",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "tokenOut",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "stablecoinAmount",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "tokenOutAmount",
                        "type": "uint256"
                    }
                ],
                "name": "StrategicSwap",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    }
                ],
                "name": "TokenAdded",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    }
                ],
                "name": "TokenRemoved",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "bnbAmount",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "sharesBurned",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "fee",
                        "type": "uint256"
                    }
                ],
                "name": "Withdrawal",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "MINIMUM_DEPOSIT",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "WBNB",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    }
                ],
                "name": "addSupportedToken",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "deposit",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "dexRouter",
                "outputs": [
                    {
                        "internalType": "contract IUniswapV2Router02",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "freeBUSDBalance",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getTotalFundValue",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    }
                ],
                "name": "removeSupportedToken",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "tokenIn",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenInAmount",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "minStablecoinOut",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "deadline",
                        "type": "uint256"
                    }
                ],
                "name": "returnToStablecoin",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "shares",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "smartEngine",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "stablecoin",
                "outputs": [
                    {
                        "internalType": "contract IERC20",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "tokenOut",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "stablecoinAmount",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "minAmountOut",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "deadline",
                        "type": "uint256"
                    }
                ],
                "name": "strategicSwapToToken",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "supportedTokens",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "tokenBalances",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalShares",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "sharesToBurn",
                        "type": "uint256"
                    }
                ],
                "name": "withdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "withdrawFees",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "stateMutability": "payable",
                "type": "receive"
            }
        ];

        const PANCAKESWAP_ROUTER_ABI = ['function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)'];

        function setError(message) {
            const errorElement = document.getElementById('error');
            const errorMessageElement = document.getElementById('error-message');
            if (errorElement && errorMessageElement) {
                errorElement.style.display = 'block';
                errorMessageElement.textContent = message;
            } else {
                console.error('Error element not found in DOM');
                console.error(message);
            }
        }

        function clearError() {
            const errorElement = document.getElementById('error');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        function showElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'block';
            }
        }

        function hideElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'none';
            }
        }

        async function checkAndDisplayNetworkButtons() {
            // 
            const networkButtons = document.getElementById('network-buttons');
            networkButtons.innerHTML = ''; // Clear existing buttons

            currentChainId = await window.ethereum.request({ method: 'eth_chainId' });

            if (currentChainId !== BSC_MAINNET_CHAIN_ID) {
                const mainnetButton = createButton('Switch to BSC Mainnet', () => switchNetwork(BSC_MAINNET_CHAIN_ID), 'bg-yellow-700 hover:bg-yellow-600');
                networkButtons.appendChild(mainnetButton);
            }

            if (currentChainId !== BSC_TESTNET_CHAIN_ID) {
                const testnetButton = createButton('Switch to BSC Testnet', () => switchNetwork(BSC_TESTNET_CHAIN_ID), 'bg-purple-700 hover:bg-purple-600');
                networkButtons.appendChild(testnetButton);
            }
        }

        function createButton(text, onClick, className) {
            const button = document.createElement('button');
            button.textContent = text;
            button.onclick = onClick;
            button.className = `${className} text-black font-bold py-2 px-4 rounded focus:outline-none mr-2 mb-2`;
            return button;
        }

        async function switchNetwork(chainId) {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: chainId }],
                });
            } catch (error) {
                if (error.code === 4902) {
                    // This error code indicates that the chain has not been added to MetaMask
                    setError(`Network is not available in MetaMask.\nAdd ${chainId} First`);
                    const networkButtons = document.getElementById('network-buttons');
                    networkButtons.innerHTML = ''; // Clear existing buttons
                    if (chainId == BSC_MAINNET_CHAIN_ID) {
                        const mainnetButton = createButton('Add BSC Mainnet', () => addNetwork(BSC_MAINNET_CHAIN_ID), 'bg-yellow-700 hover:bg-yellow-600');
                        networkButtons.appendChild(mainnetButton);
                    }

                    if (chainId == BSC_TESTNET_CHAIN_ID) {
                        const testnetButton = createButton('Add  BSC Testnet', () => addNetwork(BSC_TESTNET_CHAIN_ID), 'bg-purple-700 hover:bg-purple-600');
                        networkButtons.appendChild(testnetButton);
                    }
                    // await addNetwork(chainId);
                } else {
                    throw error;
                }
            }
        }

        async function addNetwork(chainId) {
            const network = chainId === BSC_MAINNET_CHAIN_ID
                ? {
                    chainId: BSC_MAINNET_CHAIN_ID,
                    chainName: 'Binance Smart Chain Mainnet',
                    nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                    rpcUrls: ['https://bsc-dataseed1.binance.org/'],
                    blockExplorerUrls: ['https://bscscan.com/'],
                }
                : {
                    chainId: BSC_TESTNET_CHAIN_ID,
                    chainName: 'Binance Smart Chain Testnet',
                    nativeCurrency: { name: 'BNB', symbol: 'tBNB', decimals: 18 },
                    rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
                    blockExplorerUrls: ['https://testnet.bscscan.com'],
                };

            await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [network],
            });
        }


        async function updateNetworkInfo() {
            const contractAddressElement = document.getElementById('contract-address');
            const networkTypeElement = document.getElementById('network-type');

            currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
            const addresses = CONTRACT_ADDRESSES[currentChainId];

            if (addresses) {
                contractAddressElement.textContent = `Contract: ${addresses.FUND_CONTRACT}`;
                networkTypeElement.textContent = currentChainId === BSC_MAINNET_CHAIN_ID ? 'Network: BSC Mainnet' : 'Network: BSC Testnet';
            } else {
                contractAddressElement.textContent = 'Contract: Unknown network';
                networkTypeElement.textContent = 'Network: Unsupported';
            }
        }

        async function initializeApp() {
            try {
                clearError();
                await window.ethereum.request({ method: 'eth_requestAccounts' });

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();

                currentChainId = await window.ethereum.request({ method: 'eth_chainId' });

                if (currentChainId !== BSC_MAINNET_CHAIN_ID && currentChainId !== BSC_TESTNET_CHAIN_ID) {
                    throw new Error('Unsupported network. Please switch to BSC Mainnet or Testnet.');
                }

                const addresses = CONTRACT_ADDRESSES[currentChainId];

                fundContract = new ethers.Contract(addresses.FUND_CONTRACT, FUND_ABI, signer);

                account = await signer.getAddress();
                const accountElement = document.getElementById('account');
                if (accountElement) {
                    accountElement.textContent = account;
                }

                showElement('account-info');
                showElement('fund-composition');

                await updateBalances();
                await getFundComposition();
                await checkAndDisplayNetworkButtons();
                await updateNetworkInfo();
            } catch (err) {
                if (err.message.includes('Unsupported network')) {
                    setError('Unsupported network. Please switch to BSC Mainnet or Testnet.');
                    checkAndDisplayNetworkButtons()
                } else if (err.code === 4001) {
                    setError('Please connect MetaMask to use this dApp.');
                } else {
                    setError('Failed to initialize app: ' + err.message);
                }
            }
        }

        async function updateBalances() {
            if (!provider || !fundContract || !account) return;

            try {
                const balance = await provider.getBalance(account);
                const shares = await fundContract.shares(account);
                const totalFundValue = await fundContract.getTotalFundValue();

                document.getElementById('balance').textContent = ethers.utils.formatEther(balance);
                document.getElementById('shares').textContent = ethers.utils.formatUnits(shares, 18);
                document.getElementById('total-fund-value').textContent = ethers.utils.formatUnits(totalFundValue, 18);
            } catch (err) {
                setError('Failed to update balances: ' + err.message);
            }
        }

        async function getFundComposition() {
            if (!fundContract || !provider) {
                setError('Contract or provider not initialized');
                return;
            }

            try {
                const addresses = CONTRACT_ADDRESSES[currentChainId];

                const totalValue = await fundContract.getTotalFundValue();
                const stablecoinBalance = await fundContract.freeBUSDBalance();

                const pancakeSwapRouter = new ethers.Contract(addresses.PANCAKESWAP_ROUTER, PANCAKESWAP_ROUTER_ABI, provider);

                let tokens = [];
                let balances = [];
                let busdValues = [];
                let i = 0;

                while (true) {
                    try {
                        const token = await fundContract.supportedTokens(i);
                        if (token === ethers.constants.AddressZero) {
                            break;
                        }

                        const balance = await fundContract.tokenBalances(token);
                        const formattedBalance = ethers.utils.formatUnits(balance, 18);

                        let busdValue;
                        if (token.toLowerCase() === addresses.BUSD.toLowerCase()) {
                            busdValue = parseFloat(formattedBalance);
                        } else {
                            const amounts = await pancakeSwapRouter.getAmountsOut(
                                ethers.utils.parseUnits('1', 18),
                                [token, addresses.BUSD]);
                            const tokenPriceInBUSD = ethers.utils.formatUnits(amounts[1], 18);
                            busdValue = parseFloat(formattedBalance) * parseFloat(tokenPriceInBUSD);
                        }

                        tokens.push(token);
                        balances.push(formattedBalance);
                        busdValues.push(busdValue.toFixed(2));

                        i++;
                    } catch (error) {
                        console.log(`Error fetching token at index ${i}:`, error.message);
                        break;
                    }
                }

                const compositionHtml = `
                    <p>Total Fund Value: <span class="text-yellow-400">${ethers.utils.formatUnits(totalValue, 18)}</span> BUSD</p>
                    <p>Stablecoin Balance: <span class="text-yellow-400">${ethers.utils.formatUnits(stablecoinBalance, 18)}</span> BUSD</p>
                    <h3 class="font-bold mt-2 text-green-500">Token Balances:</h3>
                    ${tokens
                        .filter(token => token.toLowerCase() !== addresses.BUSD.toLowerCase())
                        .map((token, index) => {
                            const originalIndex = tokens.indexOf(token);
                            return `
                                <p>
                                    <span class="text-blue-400">${token}:</span> 
                                    <span class="text-yellow-400">${balances[originalIndex]}</span> tokens 
                                    (â‰ˆ <span class="text-yellow-400">${busdValues[originalIndex]}</span> BUSD)
                                </p>
                            `;
                        }).join('')}
                `;

                document.getElementById('composition-details').innerHTML = compositionHtml;
            } catch (err) {
                setError('Failed to get fund composition: ' + err.message);
            }
        }

        async function handleDeposit() {
            if (!fundContract) return;
            try {
                clearError();
                const depositAmount = document.getElementById('deposit-amount').value;
                const tx = await fundContract.deposit({ value: ethers.utils.parseEther(depositAmount) });
                await tx.wait();
                updateBalances();
                getFundComposition();
                document.getElementById('deposit-amount').value = '';
            } catch (err) {
                setError('Deposit failed: ' + err.message);
            }
        }

        async function handleWithdraw() {
            if (!fundContract) return;
            try {
                clearError();
                const withdrawAmount = document.getElementById('withdraw-amount').value;
                const tx = await fundContract.withdraw(ethers.utils.parseUnits(withdrawAmount, 18));
                await tx.wait();
                updateBalances();
                getFundComposition();
                document.getElementById('withdraw-amount').value = '';
            } catch (err) {
                setError('Withdrawal failed: ' + err.message);
            }
        }

        async function init() {
            if (window.location.protocol === 'file:') {
                showElement('server-warning');
                setError('Please access this file through a web server to use MetaMask.');
                return;
            } else {
                hideElement('server-warning');
            }

            if (typeof window.ethereum !== 'undefined') {
                console.log("MetaMask is installed!");

                if (window.ethereum.isMetaMask) {
                    console.log("MetaMask is active");

                    await initializeApp();

                    // Listen for account changes
                    window.ethereum.on('accountsChanged', async (accounts) => {
                        console.log('Account changed:', accounts[0]);
                        await initializeApp();
                    });

                    // Listen for chain changes
                    window.ethereum.on('chainChanged', async (chainId) => {
                        console.log('Network changed. Updating...');
                        await initializeApp();
                    });

                } else {
                    setError('MetaMask is installed but not active. Please make sure it\'s enabled.');
                }
            } else {
                setError('Please install MetaMask to use this dApp');
            }
        }

        window.onload = init;
    </script>
</body>

</html>
